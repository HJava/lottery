<!DOCTYPE html>
<html>

<head>
    <meta name="screen-orientation" content="portrait">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0" />
    <title>年会抽奖小程序</title>
    <link rel="stylesheet" type="text/css" href="css/reset.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
</head>

<body>
    <div id="container">
        <div id="main" class="wall">
            <div class="result-btn">
                <button class="pure-button" @click="showWinnerRecords">中奖记录</button>
            </div>
            <canvas id="memberCanvas"></canvas>
        </div>
        <div id="result" class="result">
        </div>
        <div id="winnerRecords" class="winnerRecords" @click="hideWinnerRecords">
        </div>
        <div id="tools" class="tools">
            <button v-for="btn in btns" @click="onClick(btn.value)" class="pure-button"
                :class="{ 'button-error': selected == btn.value}">{{btn.name}}</button>
            <button class="pure-button" @click="toggle" :class="{'button-secondary': !running,
               'button-success': running}">{{running?'停!':'开始'}}</button>
            <button class="pure-button button-warning" @click="reset">清空抽奖记录</button>
            <button class="pure-button" @click="loadStorageInfo">读取记录</button>
        </div>
    </div>

    <script type="text/javascript" src="js/vue.min.js"></script>
    <script type="text/javascript" src="js/tagcanvas.min.js"></script>
    <script type="text/javascript" src="js/allMembers.js"></script>
    <script type="text/javascript">
        (function () {
            const KEY = '_lottery_winner';
            const RECORD_KEY = '_lottery_winner_record';
            const winnerMap = new Map();
            const winRecords = [];

            function loadStorage() {
                try {
                    let result = localStorage.getItem(KEY);
                    let record = localStorage.getItem(RECORD_KEY);

                    if (result && record) {
                        winnerMap = new Map(JSON.parse(result));
                        winRecords = JSON.parse(record);
                    } else {
                        winnerMap.clear();
                        winRecords = [];
                    }
                } catch (e) {

                }
            }

            function clearStorage() {
                localStorage.clear(KEY);
                localStorage.clear(RECORD_KEY);
            }

            function setStorage() {
                localStorage.setItem(KEY, JSON.stringify(Array.from(winnerMap.entries())));
                localStorage.setItem(RECORD_KEY, JSON.stringify(winRecords));
            }

            function addWinners(winners) {
                winRecords.push({time: Date.now(), winners});
                winners.forEach((winner) => {
                    winnerMap.set(getKey(winner), true);
                });
            }

            function initTagCanvas() {
                TagCanvas.Start('memberCanvas', '', {
                    textColour: null,
                    initial: speed(),
                    dragControl: 1,
                    textHeight: 14
                });
            }

            function speed() {
                return [0.1 * Math.random() + 0.01, -(0.1 * Math.random() + 0.01)];
            }

            function speedUp() {
                TagCanvas.SetSpeed('memberCanvas', speed());
            }

            function speedDown() {
                TagCanvas.SetSpeed('memberCanvas', [5, 1]);
            }

            function reloadTagCanvas() {
                TagCanvas.Reload('memberCanvas');
            }

            function getKey(item) {
                return item.name + '-' + item.phone;
            }

            function updateCanvasInnerHTML() {
                const html = ['<ul>'];
                allMembers.forEach((item) => {
                    let className = winnerMap.has(getKey(item)) ? 'winner' : 'member';

                    html.push(`<li><a href="#" class="${className}">${item.name}</a></li>`);
                });
                html.push('</ul>');
                document.getElementById('memberCanvas').innerHTML = html.join('');
            };

            function getRandomMembers(members, selectedNumber) {
                if (members.length <= selectedNumber) {
                    return [...members];
                }

                let currentSelectedMembers = [];

                while (currentSelectedMembers.length < selectedNumber) {
                    let random = Math.floor(Math.random() * members.length);
                    let randomMember = members[random];
                    if (currentSelectedMembers.findIndex((element) => {
                        return element.name === randomMember.name;
                    }) === -1) {
                        currentSelectedMembers.push(randomMember);
                    }
                }

                return currentSelectedMembers;
            }

            function isWinner(member) {
                return winnerMap.has(getKey(member));
            }

            function createWinnerHTML(winners) {
                return winners.reduce((prev, next) => {
                    return `${prev}<span>${next.phone}-${next.name}</span>`;
                }, '');
            }

            function createWinnerRecordsHTML() {
                if (winRecords.length === 0) {
                    return `<div class="winnerRecord">无记录!</div>`;
                }

                return winRecords.reduce((prev, next) => {
                    let winnersHTML = next.winners.map((winner) => {
                        return `<span>${winner.phone}-${winner.name}</span>`
                    });

                    return `${prev}<div class="winnerRecord"><span>${new Date(next.time).toLocaleString()}<span>:&nbsp;<span>${winnersHTML.join(',')}</span></div>`;
                }, '');
            }

            function lottery(number) {
                let list = document.getElementById('memberCanvas').getElementsByTagName('a');
                let color = 'yellow';
                let notSelectedMembers = allMembers.filter((member) => !isWinner(member));
                let newWinners = getRandomMembers(notSelectedMembers, number);

                addWinners(newWinners);
                setStorage();

                return newWinners;
            };

            function initVue() {
                new Vue({
                    el: '#container',
                    data: {
                        selected: 3,
                        running: false,
                        btns: [
                            {name: '三等奖(3)人', value: 3},
                            {name: '二等奖(2)人', value: 2},
                            {name: '一等奖(1)人', value: 1}
                        ]
                    },
                    mounted() {
                        updateCanvasInnerHTML();
                        initTagCanvas();
                    },
                    methods: {
                        reset: function () {
                            if (confirm('确定要重置么？所有之前的抽奖历史将被清除！')) {
                                clearStorage();
                                loadStorage();
                                updateCanvasInnerHTML();
                            }
                        },
                        loadStorageInfo() {
                            loadStorage();
                            updateCanvasInnerHTML();
                        },
                        showWinnerRecords() {
                            let $winnerRecords = document.querySelector('#winnerRecords');
                            if ($winnerRecords.style.display !== 'block') {
                                $winnerRecords.innerHTML = createWinnerRecordsHTML();
                                $winnerRecords.style.display = 'block';
                            }
                        },
                        hideWinnerRecords() {
                            let $winnerRecords = document.querySelector('#winnerRecords');
                            if ($winnerRecords.style.display !== ' none') {
                                $winnerRecords.innerHTML = '';
                                $winnerRecords.style.display = 'none';
                            }
                        },
                        onClick: function (num) {
                            document.querySelector('#result').style.display = 'none';
                            document.querySelector('#main').classList.remove('mask');

                            this.selected = num;
                        },
                        toggle: function () {
                            this.hideWinnerRecords();
                            if (this.running) {
                                let $result = document.querySelector('#result');

                                speedUp();
                                if (allMembers.length === winnerMap.size) {
                                    $result.style.display = 'block';
                                    $result.innerHTML = '<span>已抽完</span>'
                                    return;
                                }
                                let winners = lottery(this.selected);

                                $result.style.display = 'block';
                                $result.innerHTML = createWinnerHTML(winners);
                                updateCanvasInnerHTML();
                                reloadTagCanvas();
                                setTimeout(function () {

                                    document.querySelector('#main').classList.add('mask');
                                }, 300);
                            } else {
                                document.querySelector('#result').style.display = 'none';
                                document.querySelector('#main').classList.remove('mask');
                                speedDown();
                            }
                            this.running = !this.running;
                        }
                    }
                });
            }

            function init() {
                let canvas = document.querySelector('#memberCanvas');
                canvas.width = document.body.offsetWidth;
                canvas.height = document.body.offsetHeight;

                initVue();
            }

            init();
        })();
    </script>
</body>

</html>